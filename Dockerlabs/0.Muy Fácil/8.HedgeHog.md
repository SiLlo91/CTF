# Write-up

- **Nombre de la m√°quina:** `HedgeHog` 
- **Plataforma:** `Dockerlabs` 
- **IP:** `172.17.0.2` 
- **SO:** `Linux` 
- **Dificultad:** `Muy F√°cil`

-----------------------

## 1. RECONOCIMIENTO

El objetivo de esta fase es identificar los puntos de entrada y servicios expuestos en la m√°quina v√≠ctima.

#### 1.1. Verificaci√≥n de Conectividad

Se lanza un `ping` para confirmar que la m√°quina est√° activa y obtener el TTL lo que puede darnos una primera pista sobre el sistema operativo.
```
ping 172.17.0.2
```
Nos devuelve conectividad y un TTL=64 por lo que estamos ante una m√°quina Linux. 
![](Imagenes/199.3.png)

#### 1.2. Escaneo de Puertos

Se realiza un escaneo con **Nmap** para descubrir puertos abiertos, los servicios que corren en ellos y sus versiones.

```
sudo nmap -p- -sV -sC -sS --min-rate 5000 --open -n -Pn 172.17.0.2 -oN port_scan.txt
```

**Puertos Descubiertos:**

| Puertos | Servicios | Versi√≥n        | Notas                                                                             |
| ------- | --------- | -------------- | --------------------------------------------------------------------------------- |
| 22      | ssh       | OpenSSH 9.6    | protocolo de red seguro. Acceso remoto                                            |
| 80      | http      | Apache  2.4.58 | Protocolo de comunicaci√≥n. Transferencia de infromaci√≥n www.<br>Punto de entrada. |

![](Imagenes/199.4.png)

Normalmente el acceso por el puerto 22 al servicio ssh requiere de credenciales. Ya sea usuario y contrase√±a o clave rsa. En este caso carecemos de informaci√≥n al respecto as√≠ que lo m√°s productivo es explorar el puerto :80
## 2. ENUMERACI√ìN

Una vez identificados los servicios, se procede a investigarlos en profundidad en busca de vulnerabilidades o informaci√≥n √∫til.

### Puerto 80 ( HTTP)

#### Enumeraci√≥n Manual:



- **Navegaci√≥n web:** Se visita el sitio en `http://172.17.0.2`.
    Tenemos una p√°gina con `tails`escrito arriba a la izquierda 
    ![](Imagenes/199.5.png)

- **An√°lisis del c√≥digo fuente:** Se revisa el HTML en busca de comentarios, rutas o scripts ocultos.
    Encontramos el mismo  nombre :
	    `tails`
	    ![](Imagenes/199.6.png)
- **Archivos comunes:** Se buscan manualmente archivos y directorios comunes:
	- `/robots.txt`-->X
	- `/sitemap.xml`--> X
	- `/login`--> X
	- `/admin`--> X
	- `/panel`--> X
	- `/user`--> X
	- `/panel`--> X
	- `backup`--> X
	- `uploads`--> X
	- `test, etc.`--> X
    
    No encontramos nada

#### Enumeraci√≥n Autom√°tica:

- Lanzamos la herrmaienta `whatweb` para que nos de informaci√≥n sobre la aplicaci√≥n web. 
```
whatweb 172.17.0.2
```
![](Imagenes/199.7.png)

No nos aporta demasiado en este punto
	
- Lanzamos la herramienta de enumeraci√≥n `gobuster` para buscar directorios ocultos y extensiones .php,.txt y .html 

```
gobuster dir -u http://172.17.0.2/ -w /urs/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -x php,txt,html -k
```

![](Imagenes/199.8.png)

**Hallazgos:**

- Nos devuelve algunas rutas por defecto  pero nada llamativo.

### 22(SSH)

Si recordamos para acceder al servicio que corre en el puerto :22, el servicio `ssh`, necesitamos alg√∫n tipo de credencial. Debemos probar si con el posible usuario que hemos encontrado `tails`  podemos acceder. 

Para ello utilizaremos la fuerza bruta con la herramienta `Hydra` que probar√° un diccionario con miles de opciones de contrase√±a para el usuario que le aportamos. 
```
hydra -t 4 -l tails -P /usr/share/wordlists/rockyou.txt ssh://172.17.0.2
```

Tras varios minutos vemos que no encuentra la contrase√±a, algo que para ser un CTF sencillo llama la atenci√≥n. 

**An√°lisis fuera de la caja:** `tails` es un comando usado en Linux para mostrar las ultimas l√≠neas de un archivo. Rockyou es un diccionario gigantesco, es posible que la contrase√±a este al final del archivo y de ahi que se est√© demorando tanto. Hacemos algunas pruebas:

- Creamos un diccionario de rockyou que empiece por el final con el comando `tac` que imprime las l√≠neas de un archivo de abajo hac√≠a arriba. :

![](Imagenes/199.9.png)

```
	tac /usr/share/wordlists/rockyou.txt > rockyou_girado.txt 
```


- Tras crear el diccionario es importante limpiar las tabulaciones o los espacios que haya en el diccionario. Ten en cuenta que el diccionario esta creado con una estructura  para ser le√≠do de arriba hac√≠a abajo y al voltearlo es probable que los espacio, saltos de linea, etc provoquen que `hydra` no pueda leerlos correctamente. 
	- Por ejemplo: `passwdord\n`-->`‚ê£password

- Para ello editaremos el archivo con `sed` para que sustituya los espacios por nada:
  

```
sed -i 's/ //g' rockyou_girado.txt
```

![[199.10.png]]

- En este punto podemos lanzar `hydra` que probar√° nuestro diccionario rockyou del rev√©s.
  
```
hydra -t 4 -l tails -P rockyou_girado.txt ssh://172.17.0.2
```

![[199.11.png]]

**Credenciales obtenidas:**
- **Usuario:** `tails`
- **Contrase√±a:** `3117548331`


## 3. EXPLOTACI√ìN

### 3.1 Acceso inicial:

Con las credenciales descubiertas `tails:3117548331`  nos conectamos al servicio ssh:

```
	ssh tails@172.17.0.2
```

![](Imagenes/199.12.png)
### 3.2 Enumeraci√≥n Interna:
Una vez hemos entrado al sistema debemos hacer algunas comprobaciones.
	¬øQu√© usuario somos?
	¬øA qu√© grupo pertenecemos?
	¬øQu√© usuarios hay en el sistema?
	
#### 3.2.1 Comprobaciones

¬øQui√©nes somos? `whoami`

 ![](Imagenes/199.13.png)
 
 
¬øA qu√© grupo pertenecemos? `id`

![](Imagenes/199.14.png)

¬øQu√© usuarios hay en el sistema?
`cd /home`
`ls -la`

![](Imagenes/199.15.png)

¬øQu√© usuario tienen una shell asignada?

`cat /etc/passwd | grep sh`

![](Imagenes/199.16.png)

Revisamos los directorios de los usuarios:
`Sonic`: denegado 

![](Imagenes/199.17.png)

`ubuntu`: denegado 
![](Imagenes/199.18.png)

`tails`:

![](Imagenes/199.19.png)


Podemos ver directorios como `.cache` que no veo que tenga mucho valor tras explorarlo. 

Una buena pr√°ctica ser√≠a revisar los comandos utilizados por los usuarios en el `history`


#### 3.2.2 B√∫squeda del Vector de Escalada de privilegios:

Tras las comprobaciones iniciales, el siguinete paso es buscar una forma de elevar nuestros privilegios al usuario root. 

Una de las primeras verificaciones es comprobar qu√© permisos tiene nuestro usuario `tails` para ejecutar comando con `sudo`:
```
sudo -l
```

En este caso podemos ejecutar cualquier comando como `sonic` sin necesitar contrase√±a. 
 
![](Imagenes/199.20.png)


#### 3.2.3 Pivotar al usuario `sonic`

Pivotamos al usuario `sonic` para buscar formas de escalar privilegios

```
sudo -u sonic /bin/bash
```

```
sudo -l
```

![](Imagenes/199.21.png)
La salida nos dice que podemos ejecutar sin contrase√±a comandos como `root`. 
### 3.3 Explotaci√≥n y Escalada a Root


Descubrimos como vector de escalada que el usuario `Sonic`puede ejecutar comandos como `root` sin contrase√±a as√≠ que nos movemos a `root` verificamos la escalada y ...

```
sudo su 
whoami
```

![](Imagenes/199.22.png)

   
	Somos root üöÄ

