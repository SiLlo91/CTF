# Write-up:

- **Nombre de la m谩quina:** `Allien`
- **Plataforma:** `Dockerlabs`
- **IP:** `172.17.0.2`
- **SO:** `Linux`
- **Dificultad:** `F谩cil`

---
## 1. RECONOCIMIENTO

El objetivo de esta fase es identificar los puntos de entrada y servicios expuestos en la m谩quina v铆ctima.

#### 1.1. Verificaci贸n de Conectividad

Se lanza un `ping` para confirmar que la m谩quina est谩 activa y obtener el TTL, lo que nos da una primera pista sobre el sistema operativo.

```
 ping 172.17.0.2
```

Nos devuelve conectividad con un `TTL=64`, por lo que **estamos ante una m谩quina Linux**.

<p align="center">

<img src="Imagenes/254.png" width="800">

</p>

#### 1.2. Escaneo de Puertos

Se realiza un escaneo con **Nmap** para descubrir puertos abiertos, los servicios que corren en ellos y sus versiones.

```
sudo nmap -p- -sV -sC -sS --min-rate 5000 --open -n -Pn 172.17.0.2 -oN port_scan.txt
```

**Puertos Descubiertos:**

|**Puerto**|**Servicio**|**Versi贸n**|**Notas**|
|---|---|---|---|
|22|ssh|OpenSSH 9.2p1|A la espera de credenciales.|
|80|http|httpd 2.4|Recopilaremos informaci贸n aqu铆.|
|**139 y 445**|**smb**|**Samba**|**Vector de ataque inicial**.|
<p align="center">

<img src="Imagenes/255.png" width="800">

</p>

Normalmente el acceso por el puerto 22 requiere credenciales. Exploraremos el puerto 80 y nos centraremos en **SMB** como posible vector de ataque.

---

## 2. ENUMERACIN

Una vez identificados los servicios, se procede a investigarlos en profundidad en busca de vulnerabilidades o informaci贸n 煤til.

### Puerto 80 ( HTTP)

#### Enumeraci贸n Manual:

- **Navegaci贸n web:** Se visita el sitio en `http://172.17.0.2`. Vemos un panel de login.<p align="center">

<img src="Imagenes/256.png" width="800">

</p>

- **An谩lisis del c贸digo fuente:** No encontramos nada relevante.
- **Archivos comunes:** La b煤squeda manual no arroja resultados.

#### Enumeraci贸n Autom谩tica:

A pesar de los problemas con las herramientas, se identifican las siguientes rutas:
- `/.html`  (Status: 403) 
- `/info.php` (Status: 200)
- `/index.php` (Status: 200)
- `/productos.php` (Status: 200)
- `/.php` (Status: 403) 
- `/server-status` (Status: 403) 

**Hallazgos:**

- `http://172.17.0.2/productos.php`: Es una web con ofertas y un formulario para enviar correos electr贸nicos.
  <p align="center">

<img src="Imagenes/257.png" width="800">

</p>
    
    
- **`http://172.17.0.2/info.php`**:  Podemos ver la versi贸n de **PHP** que se est谩 ejecutando, informaci贸n sobre Apache, configuraciones, etc.
    <p align="center">

<img src="Imagenes/258.png" width="800">

</p>


---

### Puerto 445 ( SMB)

#### Enumeraci贸n Autom谩tica:

- Lanzamos la herramienta **`enum4linux`** para obtener toda la informaci贸n sobre el servicio Samba.

```
enum4linux -a -u "" -p "" 172.17.0.2
```

**Hallazgos Clave:**

- Se permite la conexi贸n mediante una **`session null`**.<p align="center">

<img src="Imagenes/259.png" width="800">

</p>

- Al conectarnos al recurso `/myshare`, encontramos un archivo de texto **`access.txt`** que contiene un  **JWT**.

- Nos reporta un listado de posibles usuarios, donde encontramos a **`satriani7`**.
  <p align="center">

<img src="Imagenes/260.png" width="800">

</p>

- Vemos un listado de directorios compartidos y sus permisos.<p align="center">

<img src="Imagenes/261.png" width="800">

</p>
  

---

## 3. EXPLOTACIN

### 3.1 Acceso inicial:

Con el usuario `satriani7`, lanzamos un ataque de fuerza bruta contra SMB utilizando **`crackmapexec`**.

```
crackmapexec smb 172.17.0.2 -u 'satriani7' -p /usr/share/wordlists/rockyou.txt
```

El ataque revela la contrase帽a: **`50cent`**.
<p align="center">

<img src="Imagenes/262.png" width="800">

</p>

Con las credenciales (`satriani7:50cent`), nos conectamos al directorio compartido `/backup24` con `smbclient`:

```
smbclient //172.17.0.2/backup24 -U satriani7
```

Dentro de la ruta `\Documents\Personal`, encontramos dos archivos importantes que descargamos con `get`: **`credentials.txt`** y **`notes.txt`**.<p align="center">

<img src="Imagenes/263.png" width="800">

</p>

El archivo `credentials.txt` contiene un listado con usuarios y contrase帽as. **Encontramos las credenciales del administrador**: `administrador:Adm1nP4ss2024`.

Re-enumeramos los recursos con **`smbmap`** usando las nuevas credenciales:

```
smbmap -H 172.17.0.2 -u administrador -p Adm1nP4ss2024
```

Vemos un nuevo directorio llamado **`home`** en el que tenemos permisos de **lectura y escritura (RW)**. <p align="center">

<img src="Imagenes/264.png" width="800">

</p>
Nos conectamos a 茅l y listamos su contenido, confirmando que es el _directory listing_ de la web.<p align="center">

<img src="Imagenes/265.png" width="800">

</p>
#### Vector de Explotaci贸n: Revershell PHP

Teniendo permisos de escritura en un directorio accesible por HTTP, la ruta de acceso inicial es la **Revershell PHP**.

1. Generamos nuestro c贸digo de `revershell` en PHP.  www.revershell.com .
2. Guardamos el c贸digo en un archivo llamado **`rever.php`**.
3. Subimos el archivo a `/home` con el comando `put rever.php`.
4. Levantamos **`netcat`** en nuestra m谩quina Kali para escuchar en el puerto: `sudo nc -nvlp 8888`.
5. Accedemos a `http://172.17.0.2/rever.php` en el navegador.

<p align="center">

<img src="Imagenes/266.png" width="800">

</p>

**Tenemos conexi贸n.**
<p align="center">

<img src="Imagenes/267.png" width="800">

</p>

---

## 4. ESCALADA DE PRIVILEGIOS

Una vez dentro como `www-data`, el objetivo es elevar los privilegios del usuario actual al de `root`.

### Estabilizaci贸n de la TTY:

Semiestabilizamos la _shell_ para poder interactuar de forma correcta:

```
script /dev/null -c bash
```

<p align="center">

<img src="Imagenes/268.png" width="800">

</p>

### 4.1. Enumeraci贸n Interna

Comprobamos que somos el usuario `www-data`.

<p align="center">

<img src="Imagenes/269.png" width="800">

</p>

驴A qu茅 grupo pertenezco? `id` nos da los detalles.

<p align="center">

<img src="Imagenes/274.png" width="800">

</p>

Revisamos los usuarios con _shell_ asignada:

```
cat /etc/passwd | grep sh
```

<p align="center">

<img src="Imagenes/270.png" width="800">

</p>

No tenemos permiso para acceder a otros directorios de usuario.
<p align="center">

<img src="Imagenes/271.png" width="800">

</p>

#### B煤squeda del Vector de Escalada:

- **Permisos Sudo:** 驴Qu茅 comandos podemos ejecutar como `root`?
    
    ```
    sudo -l
    ```
    
    **Vemos que el usuario `www-data` puede ejecutar `/usr/sbin/service` como `root` sin necesidad de contrase帽a**.
    <p align="center">

<img src="Imagenes/272.png" width="800">

</p>

Acudimos a **Gtfobins** y encontramos el c贸digo para elevarnos a `root` mediante la explotaci贸n de este binario.

### 4.2. Explotaci贸n y Escalada a Root

Ejecutamos la t茅cnica que nos proporciona Gtfobins para el comando `service`:

```
sudo service ../../bin/sh
```

<p align="center">

<img src="Imagenes/273.png" width="800">

</p>

**SOMOS ROOT **